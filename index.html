
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-5xl mx-auto bg-white p-6 rounded-lg shadow-md">
    <h1 class="text-2xl font-bold mb-4 text-center text-indigo-700">Invoice Generator</h1>

    <!-- Template download -->
    <div class="text-center mb-4">
      <a href="/template" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">üì• Download Excel Template</a>
    </div>

    <!-- Excel Upload -->
    <div class="mb-4">
      <label class="block font-semibold text-gray-700 mb-1">Upload Excel File</label>
      <input type="file" id="excelFile" accept=".xlsx,.xls" class="border rounded p-2 w-full" />
    </div>

    <!-- Editable Grid Section -->
    <div class="mt-6">
      <h2 class="text-lg font-semibold text-gray-800 mb-2">üßæ Editable Invoice Grid</h2>
      <button onclick="addRow()" class="mb-2 bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">+ Add Row</button>
      <div class="overflow-x-auto border rounded">
        <table id="invoiceTable" class="min-w-full text-sm text-center border-collapse">
          <thead class="bg-gray-200">
            <tr>
              <th class="border p-2">Invoice No</th>
              <th class="border p-2">Bill Date</th>
              <th class="border p-2">Party Name</th>
              <th class="border p-2">Item Detail</th>
              <th class="border p-2">HSN Code</th>
              <th class="border p-2">Weight</th>
              <th class="border p-2">Price/Gram</th>
              <th class="border p-2">Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <!-- Rows added dynamically -->
          </tbody>
        </table>
      </div>
      <div class="text-center mt-4">
        <button onclick="submitGrid()" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700">üîÑ Generate Invoices from Grid</button>
      </div>
    </div>
  </div>

  <script>
    let rowId = 1001;

    function addRow(data = {}) {
      const tableBody = document.getElementById("tableBody");
      const row = document.createElement("tr");

      row.innerHTML = `
        <td class="border p-1">INV-GRID-${rowId++}</td>
        <td class="border p-1"><input type="date" class="w-full" value="${data.bill_date || ''}"/></td>
        <td class="border p-1"><input type="text" class="w-full" value="${data.party_name || ''}"/></td>
        <td class="border p-1"><input type="text" class="w-full" value="${data.item_detail || ''}"/></td>
        <td class="border p-1"><input type="text" class="w-full" value="${data.hsn_code || ''}"/></td>
        <td class="border p-1"><input type="number" step="0.01" class="w-full" value="${data.weight || ''}"/></td>
        <td class="border p-1"><input type="number" step="0.01" class="w-full" value="${data.price_per_gram || ''}"/></td>
        <td class="border p-1">
          <button onclick="this.closest('tr').remove()" class="text-red-600 hover:underline">‚ùå Delete</button>
        </td>`;

      tableBody.appendChild(row);
    }

    function submitGrid() {
      const rows = document.querySelectorAll("#tableBody tr");
      const data = Array.from(rows).map(row => {
        const cells = row.querySelectorAll("td");
        return {
          invoice_number: cells[0].innerText,
          bill_date: cells[1].querySelector("input").value,
          party_name: cells[2].querySelector("input").value,
          item_detail: cells[3].querySelector("input").value,
          hsn_code: cells[4].querySelector("input").value,
          weight: parseFloat(cells[5].querySelector("input").value),
          price_per_gram: parseFloat(cells[6].querySelector("input").value)
        };
      });

      fetch('/generate-from-grid', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ invoices: data })
      })
      .then(res => res.json())
      .then(result => alert(result.message || 'Done!'))
      .catch(err => alert('Error generating invoices.'));
    }
  </script>
</body>
</html>
